From 6d7208f48e102342db2267dea61e8f06912f2262 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sat, 22 Nov 2025 10:12:43 +0000
Subject: [PATCH] Fix ERR_INSUFFICIENT_RESOURCES by optimizing scheduler and
 connection pool
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This commit fixes the resource exhaustion issue that caused ERR_INSUFFICIENT_RESOURCES errors.

Changes:
1. DataRefreshScheduler.refreshStats(): Changed from 100ms (0.1s) to 1000ms (1s)
   - Previous: 10 executions/second × 8+ queries = 80+ queries/second
   - New: 1 execution/second × 8+ queries = 8+ queries/second
   - This reduces database and Elasticsearch load by 90%

2. Added HikariCP connection pool configuration:
   - maximum-pool-size: 20 (increased from default 10)
   - minimum-idle: 5
   - connection-timeout: 30000ms
   - idle-timeout: 600000ms
   - max-lifetime: 1800000ms
   - connection-test-query: SELECT 1

3. Increased Elasticsearch timeouts:
   - connection-timeout: 10s (increased from 5s)
   - socket-timeout: 120s (increased from 60s)

These changes prevent resource exhaustion and improve system stability.
---
 .../ot/security/scheduler/DataRefreshScheduler.java   |  4 ++--
 src/main/resources/application.yml                    | 11 +++++++++--
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/src/main/java/com/ot/security/scheduler/DataRefreshScheduler.java b/src/main/java/com/ot/security/scheduler/DataRefreshScheduler.java
index 49f4954..bec0f57 100644
--- a/src/main/java/com/ot/security/scheduler/DataRefreshScheduler.java
+++ b/src/main/java/com/ot/security/scheduler/DataRefreshScheduler.java
@@ -63,9 +63,9 @@ public class DataRefreshScheduler {
     }
 
     /**
-     * 0.1초마다 통계 업데이트 및 SSE 푸시
+     * 1초마다 통계 업데이트 및 SSE 푸시
      */
-    @Scheduled(fixedRate = 100)
+    @Scheduled(fixedRate = 1000)
     public void refreshStats() {
         try {
             long totalPackets = elasticsearchService.getTotalPackets();
diff --git a/src/main/resources/application.yml b/src/main/resources/application.yml
index a0f57a5..4b55640 100644
--- a/src/main/resources/application.yml
+++ b/src/main/resources/application.yml
@@ -8,6 +8,13 @@ spring:
     username: postgres
     password: ${DB_PASSWORD:postgres}
     driver-class-name: org.postgresql.Driver
+    hikari:
+      maximum-pool-size: 20
+      minimum-idle: 5
+      connection-timeout: 30000
+      idle-timeout: 600000
+      max-lifetime: 1800000
+      connection-test-query: SELECT 1
 
   jpa:
     hibernate:
@@ -23,8 +30,8 @@ spring:
     uris: http://localhost:9200
     username: elastic
     password: ${ELASTICSEARCH_PASSWORD:}
-    connection-timeout: 5s
-    socket-timeout: 60s
+    connection-timeout: 10s
+    socket-timeout: 120s
 
 server:
   port: 8080
-- 
2.43.0

